version: "3"

services:
  matomo:
    image: matomo:fpm-alpine
    restart: always
    volumes:
      - ./matomo/config:/var/www/html/config:rw
      - ./matomo/logs:/var/www/html/logs
      - matomo:/var/www/html
    environment:
      - PHP_MEMORY_LIMIT=2048M
      - MATOMO_DATABASE_HOST=${DB_HOST}:${DB_PORT}
      - MATOMO_DATABASE_ADAPTER=${MATOMO_DATABASE_ADAPTER}
      - MATOMO_DATABASE_TABLES_PREFIX=${MATOMO_DATABASE_TABLES_PREFIX}
      - MATOMO_DATABASE_USERNAME=${MATOMO_DATABASE_USERNAME}
      - MATOMO_DATABASE_PASSWORD=${MATOMO_DATABASE_PASSWORD}
      - MATOMO_DATABASE_DBNAME=${MATOMO_DATABASE_DBNAME}

  proxy:
    image: nginx:alpine
    restart: always
    command: sh -c "while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\""
    volumes:
      - matomo:/var/www/html:ro
    ports:
      - "80:80"

volumes:
  matomo:
